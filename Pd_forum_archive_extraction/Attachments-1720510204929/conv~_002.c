#include "m_pd.h"

/* put all these out of the perform routine because you only want to initialise them once, don't you ? */
static float left[200] 
	  = { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, -0.000000, -0.000000, -0.000100, -0.000400, -0.000600, 
	     -0.000800, -0.001600, -0.002900, -0.002800, -0.002400, -0.002300, 0.019300, -0.012100, -0.017300, -0.011600, -0.004900, 0.018900, -0.037200, -0.009800, 0.025300, -0.004600, 0.437700, 0.400600, 0.033900, 0.532300, 
		 -0.088600, -0.617200, -0.360400, -0.462500, -0.359200, 0.129700, 0.314600, 0.120900, 0.164100, -0.043800, -0.232100, -0.009600, -0.041900, -0.182200, -0.103200, -0.025900, 0.003300, 0.089800, 0.088500, 0.036100, 
		  0.058100, -0.037600, -0.095100, -0.058600, -0.035300, -0.042300, -0.028100, -0.006500, -0.013700, 0.009100, 0.025500, 0.013400, -0.042300, -0.038200, -0.066100, -0.060000, -0.013500, -0.035800, -0.058900, -0.024100, 
		 -0.018300, -0.006400, 0.047400, 0.033100, 0.010100, 0.043700, 0.025500, -0.008200, 0.008400, -0.006800, -0.024000, -0.006900, 0.012300, 0.008500, 0.027300, 0.037800, 0.020700, 0.009700, 0.000900, -0.023600, -0.015700, 
		 -0.001100, -0.014000, -0.004100, 0.008700, 0.003100, 0.002300, 0.034500, 0.041100, 0.046700, 0.051300, 0.024500, -0.025700, -0.024900, -0.040600, -0.079400, -0.050000, -0.055900, -0.041800, 0.011600, 0.027800, 0.009800, 
		  0.013400, 0.005100, -0.018700, -0.017500, -0.015100, -0.018100, -0.007200, 0.006800, 0.006700, 0.012900, 0.019100, 0.014700, 0.000200, 0.005400, -0.004500, -0.016200, -0.008500, -0.021000, -0.017200, 0.000400, 0.009900, 
		  0.021500, 0.032500, 0.035500, 0.022900, 0.017700, 0.022500, 0.017300, 0.007800, 0.005900, -0.008200, 0.000800, 0.009800, 0.007100, 0.011100, 0.012900, 0.010200, 0.002200, 0.005600, 0.000200, -0.002900, -0.002900, -0.004100, 
		 -0.002100, 0.003200, 0.005900, 0.003800, 0.003500, -0.001100, -0.005100, -0.002200, -0.002400, -0.003600, -0.001100, 0.000300, 0.003600, 0.003900, 0.002600, 0.001300, -0.000600, -0.001200, -0.002600, -0.003600, -0.004100, 
		 -0.004900, -0.004100, -0.003700, -0.002600, -0.001900, -0.001800, -0.000700, -0.000900, 0.000100, -0.000300, -0.000600, 0.000500, -0.000100, -0.000200};

static float right[200]
	  = { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, -0.000000, 0.000000, -0.000000, 0.000000, -0.000100, -0.000200, -0.000400, -0.001300, 
	     -0.000500, -0.003600, 0.013100, 0.016600, -0.035200, -0.004400, 0.000200, 0.001500, 0.001200, -0.013200, -0.019700, 0.019300, -0.022600, 0.235600, 0.667900, 0.024300, 0.181700, 0.475900, -0.504300, -0.523100, -0.383300, 
		 -0.354100, -0.195000, 0.228500, 0.325700, -0.014900, 0.130600, -0.080400, -0.241800, -0.040700, 0.030600, -0.149200, -0.121000, 0.018700, 0.039700, 0.014000, 0.069200, 0.009200, -0.070200, 0.002400, -0.004000, -0.034300, 
		  0.041500, 0.022900, 0.007300, -0.010900, -0.035900, -0.020900, -0.034000, -0.033200, -0.065200, -0.061900, -0.047500, -0.029800, -0.035100, -0.036800, -0.013400, -0.026100, -0.001300, 0.009100, 0.029200, 0.041500, 0.011400, 
		  0.003100, 0.019300, 0.009600, -0.008800, -0.012200, -0.012900, 0.016600, 0.023200, 0.012700, 0.010000, -0.008600, -0.011600, -0.023400, -0.014900, -0.005200, -0.007600, -0.010100, -0.012600, -0.003000, 0.002300, 0.017400, 
		  0.037600, 0.025700, 0.006000, 0.032900, 0.010900, -0.015400, 0.017500, -0.004200, -0.032900, -0.017600, -0.028800, -0.038700, 0.001800, 0.003900, -0.025800, -0.036000, -0.030200, -0.022500, -0.004600, 0.017400, 0.022100, 
		 -0.002000, 0.008400, 0.006300, -0.002700, 0.008400, -0.001700, -0.012300, -0.028300, -0.023500, -0.013600, -0.013100, -0.002600, -0.004200, 0.001700, 0.008500, 0.019800, 0.028200, 0.024100, 0.027100, 0.022600, 0.012000, 
		  0.011900, 0.013400, 0.005700, 0.003100, 0.001800, 0.002500, 0.008700, 0.002500, 0.003100, 0.006600, 0.002900, 0.005800, 0.005300, 0.002400, 0.001800, -0.001600, -0.001200, 0.002300, 0.003000, 0.001000, -0.000200, -0.002400, 
		 -0.001600, -0.000200, 0.005000, 0.009600, 0.005600, 0.004900, 0.004100, 0.001000, -0.000600, -0.001600, -0.005100, -0.006700, -0.005200, -0.006700, -0.005900, -0.005500, -0.005200, -0.004100, -0.004000, -0.003100, -0.002500, 
		 -0.002100, -0.000100, 0.000400, 0.000200, 0.000400, 0.000700, 0.000600, -0.000100, 0.000200, 0.000300};
 
/* could zeroe them out more elegantly in the new-routine */
static float lout[200]
	  = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
	      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
		  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

static float rout[200]
	  = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
	      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
		  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};


static t_class *conv_tilde_class;

typedef struct _conv_tilde {
  t_object  x_obj;
  t_sample f_conv;
  t_sample f;
} t_conv_tilde;

t_int *conv_tilde_perform(t_int *w)
{
  t_conv_tilde *x = (t_conv_tilde *)(w[1]);
  t_float  *in1 =    (t_float *)(w[2]);
  t_float  *in2 =    (t_float *)(w[3]);
  t_float  *out1 =    (t_float *)(w[4]);
  t_float  *out2 =    (t_float *)(w[5]);
  int         n =           (int)(w[6]);
  int         i;
 
    
   while (n--)
   {
      	
	t_float lsum = 0.0;
	t_float rsum = 0.0;
  
	   
	for(i=199; i>=0; i--)
      	{
		lout[i]=lout[i-1];         /*updates arrays*/
	    rout[i]=rout[i-1];	/* move line by line... ? */
	}
		
		lout[0]=(*in1++);      /*add new value*/
        rout[0]=(*in2++);

	for(i=0; i<200; i++)
	{
		lsum+=left[i]*lout[i];    /*multiplies and adds samples for convolution*/
		rsum+=right[i]*rout[i];
	}



	   *out1++ = lsum;
	   *out2++ = rsum;
  




   } /*end while*/

  
  /*t_sample f_conv = (x->f_conv<0)?0.0:(x->f_conv>1)?1.0:x->f_conv;

    while (n--) *out++ = (*in1++)*(1-f_conv)+(*in2++)*f_conv;*/

  return (w+7);
}

void conv_tilde_dsp(t_conv_tilde *x, t_signal **sp)
{
  dsp_add(conv_tilde_perform, 6, x,
          sp[0]->s_vec, sp[1]->s_vec, sp[2]->s_vec, sp[3]->s_vec, sp[0]->s_n);
}

void *conv_tilde_new(t_floatarg f)
{
  t_conv_tilde *x = (t_conv_tilde *)pd_new(conv_tilde_class);

  x->f_conv = f;
  
  inlet_new(&x->x_obj, &x->x_obj.ob_pd, &s_signal, &s_signal);
  floatinlet_new (&x->x_obj, &x->f_conv);
  outlet_new(&x->x_obj, &s_signal);
  outlet_new(&x->x_obj, &s_signal);	/* second outlet for stereo */

  return (void *)x;
}

void conv_tilde_setup(void) {
  conv_tilde_class = class_new(gensym("conv~"),
        (t_newmethod)conv_tilde_new,
        0, sizeof(t_conv_tilde),
        CLASS_DEFAULT, 
        A_DEFFLOAT, 0);

  class_addmethod(conv_tilde_class,
        (t_method)conv_tilde_dsp, gensym("dsp"), 0);
  CLASS_MAINSIGNALIN(conv_tilde_class, t_conv_tilde, f);
}

